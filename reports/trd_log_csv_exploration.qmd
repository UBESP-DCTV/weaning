---
title: "trd_log_csv_exploration"
author: "Andrea Pedot"
format: html
editor: visual
---

## Introduzione

```{r}
library(tidyverse)
library(readxl)
library(lubridate)
```

I file principali utilizzati nello studio sono 4

-   il file excel "pt_names dati inclusione", che contiene una riga per paziente, con il successo o l'insuccesso del tentativo di svezzamento

-   il file excel "pt_registry dati giornalieri", che contiene una riga al giorno per paziente, che contiene i dati raccolti clinicamente oppure quelli da analisi di laboratorio (es. prelievo di sangue arterioso) e la storia clinica limitatamente a data di ricovero ospedaliero, in ICU, svezzamento, reintubazione, comparsa di complicanze e fine del ricovero

-   il file "TRD", aggegato in uno per paziente, che contiene una riga per minuto per paziente, contiene i dati registrati dal ventilatore, limitatamente allo stato del paziente

-   il file "LOG" aggegato in uno per paziente, che contiene una riga per minuto per paziente, contiene i dati registrati dal ventilatore, limitatamente ai segnali, gli allarmi e ai parametri che vengono impostati

Da questi dati è possibile ricostruire la storia di ogni tentativo di SBT o Trial di Respiro Spontaneo (potenzialmente anche molti per paziente, uno al giorno fino a quello di successo che porta allo svezzamento dal ventilatore).

L'ipotesi sperimentale che si vuole testare è se un modello sia in grado di offrire una performance soddisfacente nel predire l'esito del SBT dai dati raccolti nelle 24h che lo precedono.

## Pazienti inclusi

Dei 180 pazienti inclusi nello studio sono registrate le colonne che lo descrivono, in cui "id_univoco" contiene la chiave di associazione presente anche negli altri file.

Rilevanti come variabili che non cambiano durante il ricovero, potenzialmente utili per un'analisi successiva:

-   variabili demografiche come "sesso", "anni_eta", "kg_peso", "cm_altezza", "bmi" e "ibw"

-   le ragioni d'inizio della ventilazione meccanica in "name reason_mv"

-   date rilevanti come "data_ricovero ospedaliero", "data_ricovero_terapia intensiva", "data_inizio ventilazione meccanica", "data_fine ventilazione meccanica", "data_out_ti", "data_dimissione"

Mentre le altre colonne contengono variabili ridondanti, derivate oppure disponibili solo alla fine del ricovero del paziente.

```{r}
pt_names <- tar_read(pt_names)

glimpse(pt_names)
```

A titolo esplorativo, si mostra la distribuzione dei giorni di ricovero, di terapia intensiva e di ventilazione meccanica

```{r}
ggplot(pt_names) +
  geom_histogram(aes(osp_out - osp_in),
                 fill = "red", alpha = 0.3) +
  geom_histogram(aes(icu_out - icu_in),
                 fill = "blue", alpha = 0.3) +
  geom_histogram(aes(vm_fine - vm_inizio),
                 fill = "green", alpha = 0.3) +
  facet_wrap(~esito)
```

## Registro giornaliero dei pazienti

Tenendo a mente che in una giornata si svolge al più un SBT, l'obiettivo è quello di costruire per ogni paziente che rispetta i criteri della tabella 1 (che rispondono alla domanda "sospetto che il paziente possa essere pronto per un SBT?"), una riga che contenga tutti i dati delle 24 precedenti e il risultato.

Si noti come in questo caso la probabilità sia condizionata sulla risposta positiva alla valutazione clinica, visto che l'SBT non viene eseguito se non dietro decisione del medico.

Le variabili d'interesse sono:

-   "id_registry"

-   "id_univoco", che è chiave in comune con il file excel dei pz inclusi

-   "deleted", che permette di individuare le righe che contengono dati errati o incompleti

-   "data_lettura" identifica la data alla quale il tentativo si riferisce

-   le variabili che iniziano con "ega" contengono dati sull'emogasanalisi (ma non si riesce a determinare se prima o dopo l'SBT)

-   le colonne che hanno come descrizione "weaning" e "SBT criteri di interruzione" contengono i parametri delle tabelle 1 (pre-SBT) e 2 (post-SBT)

-   la variabile di esito "estubato" contiene informazioni sullo stato d'estubazione (non sull'azione), mentre la variabile "reintubato" contiene informazioni sull'azione di reintubazione (non sullo stato)

```{r, echo=FALSE}
pt_registry <- tar_read(pt_registry)

glimpse(pt_registry)
```

```{r}
pt_registry |>
  select(id_univoco, susp_tot, giorno_studio) |>
  ggplot(aes(x = giorno_studio,
             y = susp_tot)) +
  geom_density_2d(color = "gray") +
  geom_smooth()
```

## File TRD

Ogni ventilatore mentre è attaccato al paziente, registra dei dati ogni minuto, somma o media (dipende dalla variabile), mentre i dati LOG registrano parametri e allarmi associandoli al momento in cui avvengono.

Si seleziona, nel paziente BS_008, un giorno di svezzamento. Per trovarlo, si filtra il registro giornaliero dei pazienti.

```{r}
pt_registry |>
  dplyr::filter(
    id_univoco == "BS008",
    susp_tot == 12
  ) |>
  dplyr::select(data_lettura, estubato, reintubato)
```

A questo punto è possibile procedere all'importazione dei file e a selezionarle unicamente 24h in cui è avvenuto lo svezzamento.

```{r}
paz <- c( ospedale = "BS",
          paziente = 8)

trd <- tar_read(weaningsTRD) |> 
  filter( folder == paz["ospedale"],
          id_pat == paz["paziente"]) # giorno di svezzamento

```

A questo punto è possibile aprire i dati e verificare cosa contengono.

Innanzitutto si plottano tutte le variabili vs l'ora, così da identificare quelle che mostrano un cambiamento durante uno SBT.

```{r}
trd %>%
  filter(date == "2013-11-27") %>%
  select_if( function(x) {!all(is.na(x))} ) %>%
  gather(-ora, key = "var", value = "value") %>% 
  ggplot(aes(x = ora,
             y = value)) +
    geom_point(size = 0.5) +
    facet_wrap(~ var, scales = "free")
```

Da cui si ricava che quelle più interessanti sono:

-   lavoro respiratorio del ventilatore (del pz è meno rilevante)

-   pressione di picco delle vie aeree

-   pressione media delle vie aeree

-   pressione di fine espirazione

```{r}
trd |>
ggplot() +
  geom_line(aes(ora, pressione_di_fine_esp_cm_h2o)) +
  geom_line(aes(ora, lavoro_respiratorio_del_paziente_joule_l),
            color = "blue") +
  facet_wrap(~date)
```

I tentativi di SBT si sospetta che siano quei momenti in cui per circa 30m i parametri si modificano in modo significativo.

## File Log

```{r}
`%ni%` <- Negate(`%in%`)
log <- tar_read(weaningsLOG) |> 
  filter( folder == paz["ospedale"],
          id_pat == paz["paziente"],
          data   == "2013-12-08") # giorno di svezzamento
```

Del quale sono interessanti alcune "informazioni" particolari:

-   con codice 0 : "standby" che identifica il momento in cui si spegne il ventilatore (e "inizio ventilazione" che ne è la ripresa)

-   con codice 267: "pressione sopra PEEP" sembra identificare una delle azioni che avvengono immediatamente prima oppure durante un SBT (ma non solo)

## Un esempio: il paziente TS015

Come esempio, iniziamo da uno slice di dati relativi unicamente a questo paziente.

```{r}
ts15_names <- pt_names |>
  filter(id_univoco == "TS015")
glimpse(ts15_names)
```

```{r}
ts15_registry <- pt_registry |>
  filter(id_univoco == "TS015")
ts15_registry |>
  select(data_lettura, estubato, susp_tot)
```

Il pz viene estubato dopo 3 giorni nello studio (attenzione: si parte da 0 al ricovero), non appena raggiunge un valore complessivo di readiness di 12/12.

Si deduce dal fatto che viene estubato lo stesso giorno, che l'SBT ha avuto successo.

```{r}
paz <- c( ospedale = "TS",
          paziente = 15)

ts15_trd <- tar_read(weaningsTRD) |> 
  filter( folder == paz["ospedale"],
          id_pat == paz["paziente"])

ts15_log <- tar_read(weaningsLOG) |> 
  filter( folder == paz["ospedale"],
          id_pat == paz["paziente"])
```

A questo punto si può procedere ad alcune visualizzazioni per valutare la salute dei dati.

Ad esempio, si verifica che i giorni di ricovero elencati nel registro clinico, quelli in cui c'è un registro del log e quelli nel trd siano identici.

```{r}
ts15_history <- tibble() |>
  bind_rows(
    list( "type" = "names",
          "subtype" = "icu_in",
          "value" = ts15_names[["icu_in"]]),
    list( "type" = "names",
          "subtype" = "icu_out",
          "value" = ts15_names[["icu_out"]]),
    list( "type" = "names",
          "subtype" = "vm_inizio",
          "value" = ts15_names[["vm_inizio"]]),
    list( "type" = "names",
          "subtype" = "vm_fine",
          "value" = ts15_names[["vm_fine"]])) |>
  bind_rows(
    bind_cols(
      "type" = "registry",
      "subtype" = "data",
      distinct(ts15_registry, data_lettura)
      ) |>
      rename(value = data_lettura)) |>
  bind_rows(
    bind_cols(
      "type" = "log",
      "subtype" = "data",
      distinct(ts15_log, data)
      ) |>
      rename(value = data)) |>
  bind_rows(
    bind_cols(
      "type" = "trd",
      "subtype" = "data",
      distinct(ts15_trd, date)
      ) |>
      rename(value = date))
```

```{r}
ts15_history |>
  ggplot(aes( x = value )) +
  geom_point( aes( y = type)) +
  geom_segment(aes(   y = "names", yend = "names",
                      x = ts15_history %>%
                        filter(subtype == "icu_in") %>%
                        pull(value),
                      xend = ts15_history %>%
                        filter(subtype == "icu_out") %>%
                        pull(value)),
               color = "dark orange",
               size = 0.5) +
  geom_segment(aes(   y = "names", yend = "names",
                      x = ts15_history %>%
                        filter(subtype == "vm_inizio") %>%
                        pull(value),
                      xend = ts15_history %>%
                        filter(subtype == "vm_fine") %>%
                        pull(value)),
               color = "dark red",
               linetype = "dashed",
               size = 0.5)
```

In secondo luogo, si verifica che la progressione delle righe corrisponda a una progressione degli orari di registrazione.

```{r}
ts15_log |>
  rowid_to_column(var = "id_row") |>
  ggplot() +
  geom_point(aes(x = id_row,
                 y = ora,
                 color = as.factor(data)) ) +
  labs( title = "Plot of LOG data",
        subtitle = "Patient TS015",
        y = "ora",
        x = "row number")
```

```{r}
ts15_trd |>
  rowid_to_column(var = "id_row") |>
  ggplot() +
  geom_point(aes(x = id_row,
                 y = ora,
                 color = as.factor(date)) ) +
  labs( title = "Plot of TRD data",
        subtitle = "Patient TS015",
        y = "ora",
        x = "row number")
```

```{r}
ggplot() +
  # TRD file
  geom_violin( data = ts15_trd,
                aes( x = as_datetime(paste(date,ora)),
                     y = "TRD"),
               scale="count",
               alpha = 0.2,
               fill = "blue") +
  geom_segment( data = ts15_trd,
                aes( y = "TRD", yend = "TRD",
                     x = min(as_datetime(paste(date,ora))),
                     xend = max(as_datetime(paste(date,ora)))),
                color = "dark blue",
                size = 1) +
  geom_point( data = ts15_trd,
                aes( y = "TRD",
                     x = min(as_datetime(paste(date,ora)))),
                color = "dark blue",
                size = 2) +
  geom_point( data = ts15_trd,
                aes( y = "TRD",
                     x = max(as_datetime(paste(date,ora)))),
                color = "dark blue",
                size = 2) +
  # LOG file
  geom_violin( data = ts15_log,
                aes( x = time,
                     y = "LOG"),
               scale="count",
               alpha = 0.2,
               fill = "violet") +
  geom_segment( data = ts15_log,
                aes( y = "LOG", yend = "LOG",
                     x = min(time),
                     xend = max(time)),
                color = "purple",
                size = 1) +
  geom_point( data = ts15_log,
                aes( y = "LOG",
                     x = min(time)),
                color = "purple",
                size = 2) +
  geom_point( data = ts15_log,
                aes( y = "LOG",
                     x = max(time)),
                color = "purple",
                size = 2) +
  # Registry file
  geom_point( data = ts15_registry,
              aes( x = as.POSIXct(data_lettura),
                   y = "Registry",
                   size = susp_tot,
                   color = (susp_tot == 12)),
              show.legend = c(size = FALSE,
                              color = TRUE)) +
  scale_radius(range = c(2,4)) +
  # Names file
  ## ICU
  geom_segment( data = ts15_names,
                aes( y = "ICU", yend = "ICU",
                     x = as.POSIXct(icu_in),
                     xend = as.POSIXct(icu_out)),
                color = "dark grey",
                size = 2) + 
  geom_point( data = ts15_names,
                aes( y = "ICU",
                     x = as.POSIXct(icu_in)),
                color = "dark grey",
                size = 4) +
  geom_point( data = ts15_names,
                aes( y = "ICU",
                     x = as.POSIXct(icu_out)),
                color = "dark grey",
                size = 4) +
  geom_text( data = ts15_names,
             aes( x = as.POSIXct(icu_out -1),
                  y = "ICU", 
                  label = "in ICU"),
             nudge_y = -0.3,
             color = "dark grey") +
  ## MV
  geom_segment( data = ts15_names,
                aes( y = "ICU", yend = "ICU",
                     x = as.POSIXct(vm_inizio),
                     xend = as.POSIXct(vm_fine)),
                color = "black",
                size = 1) + 
  geom_point( data = ts15_names,
                aes( y = "ICU",
                     x = as.POSIXct(vm_inizio)),
                color = "black",
                size = 2) +
  geom_point( data = ts15_names,
                aes( y = "ICU",
                     x = as.POSIXct(vm_fine)),
                color = "black",
                size = 2) +
  geom_text( data = ts15_names,
             aes( x = as.POSIXct(vm_inizio +2),
                  y = "ICU", 
                  label = "in Ventilazione Meccanica"),
             nudge_y = 0.3,
             color = "black") +
  # Title and Labels
  labs( title = "Plot of patient history",
        subtitle = "Patient TS015",
        x = "",
        y = "",
        color = "Ready for SBT") +
  scale_y_discrete(limits = c("LOG", "TRD", "Registry", "ICU")) 

```
